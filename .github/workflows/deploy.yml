name: Deploy to Oracle Cloud
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.ORACLE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to Oracle Cloud
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'EOF'
          set -e  # Exit on any error

          echo "🚀 Starting deployment to Oracle Cloud..."

          cd /home/opc/reverse-bundling

          echo "📥 Pulling latest changes from main branch..."
          git pull origin main

          echo "💾 Applying production database configuration..."
          git stash pop || echo "No stashed changes to apply"

          echo "📦 Installing dependencies..."
          npm install --production=false

          echo "🔨 Building application..."
          npm run build

          echo "🗄️ Running database migrations..."
          npx prisma generate
          npx prisma db push --accept-data-loss || echo "Database schema already up to date"

          echo "🔄 Restarting application service..."
          sudo systemctl restart reverse-bundling.service

          echo "⏳ Waiting for application to start..."
          sleep 10

          echo "🏥 Checking application health..."
          if curl -f http://localhost:3000/health 2>/dev/null; then
            echo "✅ Deployment completed successfully!"
            echo "🌐 Application is running and healthy"
          else
            echo "⚠️ Application deployed but health check failed"
            echo "🔍 Check application logs for details"
            exit 1
          fi
        EOF
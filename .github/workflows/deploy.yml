name: Deploy to Oracle Cloud
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.ORACLE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to Oracle Cloud
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'EOF'
          set -e  # Exit on any error

          echo "🚀 Starting deployment to Oracle Cloud..."

          cd /home/opc/reverse-bundling

          echo "📥 Pulling latest changes from main branch..."
          # Reset any local changes to avoid merge conflicts
          git reset --hard HEAD
          git clean -fd
          git pull origin main --force

          echo "🧹 Cleaning previous build artifacts..."
          rm -rf node_modules package-lock.json
          npm cache clean --force

          echo "📦 Installing dependencies..."
          npm install --production=false

          echo "🔧 Setting up production environment..."
          if [ ! -f .env.production ]; then
            echo "⚠️ .env.production not found, copying from example..."
            cp .env.production.example .env.production || echo "No example file found, using existing env vars"
          fi

          echo "🔨 Building application..."
          npm run build

          echo "🗄️ Running database migrations..."
          npx prisma generate
          if npx prisma db push --accept-data-loss; then
            echo "✅ Database migration completed successfully"
          else
            echo "⚠️ Database migration failed, but continuing deployment..."
          fi

          echo "🔄 Restarting application service..."
          sudo systemctl restart reverse-bundling.service

          echo "⏳ Waiting for application to start..."
          sleep 15

          echo "🏥 Checking application health..."
          for i in {1..3}; do
            if curl -f -s http://localhost:3000/health > /dev/null 2>&1; then
              echo "✅ Deployment completed successfully!"
              echo "🌐 Application is running and healthy"
              exit 0
            fi
            echo "⏳ Health check attempt $i failed, waiting..."
            sleep 5
          done

          echo "❌ Deployment completed but health check failed after 3 attempts"
          echo "🔍 Check application logs: sudo journalctl -u reverse-bundling.service -n 50"
          exit 1
        EOF
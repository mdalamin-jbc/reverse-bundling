name: Deploy to Oracle Cloud
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.ORACLE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to Oracle Cloud
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'EOF'
          set -e  # Exit on any error

          echo "ğŸš€ Starting deployment to Oracle Cloud..."

          cd /home/opc/reverse-bundling

          echo "ğŸ“¥ Pulling latest changes from main branch..."
          # Reset any local changes to avoid merge conflicts
          git reset --hard HEAD
          git clean -fd
          git pull origin main --force

          echo "ğŸ§¹ Cleaning previous build artifacts..."
          rm -rf node_modules package-lock.json
          npm cache clean --force

          echo "ğŸ“¦ Installing dependencies..."
          npm install --production=false

          echo "ğŸ”§ Setting up production environment..."
          if [ ! -f .env.production ]; then
            echo "âš ï¸ .env.production not found, copying from example..."
            cp .env.production.example .env.production || echo "No example file found, using existing env vars"
          fi

          echo "ğŸ”¨ Building application..."
          npm run build

          echo "ğŸ—„ï¸ Running database migrations..."
          npx prisma generate
          if npx prisma db push --accept-data-loss; then
            echo "âœ… Database migration completed successfully"
          else
            echo "âš ï¸ Database migration failed, but continuing deployment..."
          fi

          echo "ğŸ”„ Restarting application service..."
          sudo systemctl restart reverse-bundling.service

          echo "â³ Waiting for application to start..."
          sleep 15

          echo "ğŸ¥ Checking application health..."
          for i in {1..3}; do
            if curl -f -s http://localhost:3000/health > /dev/null 2>&1; then
              echo "âœ… Deployment completed successfully!"
              echo "ğŸŒ Application is running and healthy"
              exit 0
            fi
            echo "â³ Health check attempt $i failed, waiting..."
            sleep 5
          done

          echo "âŒ Deployment completed but health check failed after 3 attempts"
          echo "ğŸ” Check application logs: sudo journalctl -u reverse-bundling.service -n 50"
          exit 1
        EOF
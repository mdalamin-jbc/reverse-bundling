name: Deploy to Oracle Cloud
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SSH key
      run: |
        set -e
        echo "Setting up SSH configuration..."

        # Create SSH directory with proper permissions
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh

        # Setup SSH key - handle multiline key properly
        if [ -z "${{ secrets.ORACLE_SSH_PRIVATE_KEY }}" ]; then
          echo "‚ùå ORACLE_SSH_PRIVATE_KEY secret is not set or empty"
          exit 1
        fi

        # Write SSH key with proper formatting
        cat > ~/.ssh/id_rsa << EOF
        ${{ secrets.ORACLE_SSH_PRIVATE_KEY }}
        EOF
        chmod 600 ~/.ssh/id_rsa

        # Validate SSH key format
        if ! ssh-keygen -l -f ~/.ssh/id_rsa > /dev/null 2>&1; then
          echo "‚ùå ORACLE_SSH_PRIVATE_KEY is not a valid SSH private key"
          exit 1
        fi

        # Setup known hosts
        if [ -z "${{ secrets.ORACLE_HOST }}" ]; then
          echo "‚ùå ORACLE_HOST secret is not set"
          exit 1
        fi

        if [ -z "${{ secrets.ORACLE_USER }}" ]; then
          echo "‚ùå ORACLE_USER secret is not set"
          exit 1
        fi

        ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
        chmod 644 ~/.ssh/known_hosts

        echo "‚úÖ SSH setup completed successfully"

        # Test SSH connection
        echo "üîç Testing SSH connection..."
        if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} "echo 'SSH connection successful'" 2>/dev/null; then
          echo "‚úÖ SSH connection test passed"
        else
          echo "‚ùå SSH connection test failed"
          echo "üîß Please verify:"
          echo "   - SSH private key is correct and matches the public key on Oracle Cloud"
          echo "   - ORACLE_HOST is the correct IP/hostname"
          echo "   - ORACLE_USER has SSH access to the instance"
          exit 1
        fi

    - name: Deploy to Oracle Cloud
      run: |
        ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -o ConnectTimeout=30 -i ~/.ssh/id_rsa ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'EOF'
          set -e  # Exit on any error

          echo "üöÄ Starting deployment to Oracle Cloud..."

          cd /home/opc/reverse-bundling

          echo "üì• Pulling latest changes from main branch..."
          git fetch origin
          git reset --hard origin/main

          echo "üßπ Cleaning up previous installation..."
          rm -rf node_modules package-lock.json .next build
          npm cache clean --force 2>/dev/null || true

          echo "üíæ Setting up memory optimization..."
          # Add swap space for better npm performance
          sudo swapoff -a 2>/dev/null || true
          sudo fallocate -l 2G /swapfile 2>/dev/null || sudo dd if=/dev/zero of=/swapfile bs=1M count=2048 2>/dev/null
          sudo chmod 600 /swapfile 2>/dev/null || true
          sudo mkswap /swapfile 2>/dev/null || true
          sudo swapon /swapfile 2>/dev/null || true

          echo "üì¶ Installing dependencies efficiently..."
          # Use npm install with better memory management and retry logic
          set +e  # Temporarily disable exit on error for retry logic

          echo "üîÑ Installing dependencies with memory optimization..."
          # Increase Node.js memory limit and use production install
          NODE_OPTIONS="--max-old-space-size=1024" timeout 900 npm ci --prefer-offline --no-audit --no-fund --no-progress
          INSTALL_EXIT_CODE=$?

          if [ $INSTALL_EXIT_CODE -ne 0 ]; then
            echo "‚ö†Ô∏è Production install failed, trying development install..."
            NODE_OPTIONS="--max-old-space-size=1024" timeout 900 npm install --prefer-offline --no-audit --no-fund --no-progress
            INSTALL_EXIT_CODE=$?
          fi

          if [ $INSTALL_EXIT_CODE -ne 0 ]; then
            echo "‚ö†Ô∏è Standard install failed, trying with script skipping..."
            NODE_OPTIONS="--max-old-space-size=1024" timeout 900 npm install --prefer-offline --no-audit --no-fund --no-progress --ignore-scripts
            INSTALL_EXIT_CODE=$?

            if [ $INSTALL_EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Dependencies installed, now running Prisma generate manually..."
              NODE_OPTIONS="--max-old-space-size=1024" timeout 300 npx prisma generate
              if [ $? -ne 0 ]; then
                echo "‚ö†Ô∏è Prisma generate failed, but continuing..."
              fi
            fi
          fi

          set -e  # Re-enable exit on error

          if [ $INSTALL_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Dependency installation failed after all attempts"
            exit 1
          fi

          echo "üî® Building application..."
          # Set higher memory limit and build with extended timeout
          NODE_OPTIONS="--max-old-space-size=1024" timeout 900 npm run build

          echo "üßπ Cleaning up temporary files..."
          sudo swapoff /swapfile 2>/dev/null || true
          sudo rm -f /swapfile 2>/dev/null || true

          echo "üóÑÔ∏è Running database migrations..."
          npx prisma generate
          npx prisma db push --accept-data-loss || echo "Database schema already up to date"

          echo "üîÑ Restarting application..."
          # Kill existing process and start new one
          pkill -f "remix-serve" || true
          cd /home/opc/reverse-bundling
          nohup node --max-old-space-size=128 ./node_modules/.bin/remix-serve ./build/server/index.js >> app.log 2>&1 &

          echo "‚è≥ Waiting for application to start..."
          sleep 15

          echo "üè• Checking application health..."
          if curl -f --max-time 30 http://localhost:3000/health 2>/dev/null; then
            echo "‚úÖ Deployment completed successfully!"
            echo "üåê Application is running and healthy"
          else
            echo "‚ö†Ô∏è Application deployed but health check failed"
            echo "üîç Check application logs for details"
            exit 1
          fi
        EOF
name: Deploy to Oracle Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Oracle Cloud
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ORACLE_HOST }}
        username: ${{ secrets.ORACLE_USER }}
        key: ${{ secrets.ORACLE_SSH_PRIVATE_KEY }}
        port: 22
        timeout: 15m  # Increased from 30s to 15 minutes
        script: |
          # Set up error handling
          set -e
          set -o pipefail

          cd /home/opc/reverse-bundling

          echo "ğŸš€ Starting deployment at $(date)..."

          # Function to log with timestamp
          log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
          }

          # Function to handle errors
          error_exit() {
            log "âŒ Deployment failed at step: $1"
            log "ğŸ“‹ Last 50 lines of app.log:"
            tail -50 app.log 2>/dev/null || echo "No log file found"
            exit 1
          }

          # Check git status
          log "ğŸ“‹ Checking git status..."
          git status || error_exit "git status"

          # Pull latest changes
          log "â¬‡ï¸ Pulling latest changes..."
          git pull origin main --no-edit || error_exit "git pull"

          # Show latest commit
          log "ğŸ“ Latest commit:"
          git log -1 --oneline

          # Load environment variables
          log "ğŸ”§ Loading environment variables..."
          if [ -f ".env.production" ]; then
            set -a
            source .env.production
            set +a
            log "âœ… Environment variables loaded"
          else
            log "âš ï¸ Warning: .env.production not found, using system environment"
          fi

                    # Clean node_modules if it exists to avoid npm ci issues
          log "ğŸ§¹ Cleaning node_modules..."
          if [ -d "node_modules" ]; then
            rm -rf node_modules || log "âš ï¸ Warning: Could not remove node_modules, continuing..."
          fi

          # Install dependencies
          log "ğŸ“¦ Installing dependencies..."
          npm ci --production=false || error_exit "npm ci"

          # Database setup
          log "ğŸ—„ï¸ Setting up database..."
          npm run setup || error_exit "database setup"

          # Build the application
          log "ğŸ”¨ Building application..."
          npm run build || error_exit "npm run build"

          # Kill existing process gracefully
          log "ğŸ›‘ Stopping existing application..."
          if pgrep -f 'remix-serve' > /dev/null; then
            pkill -TERM -f 'remix-serve' || log "âš ï¸ Warning: Could not terminate gracefully"
            sleep 5
            if pgrep -f 'remix-serve' > /dev/null; then
              log "Force killing remaining processes..."
              pkill -KILL -f 'remix-serve' || true
            fi
          else
            log "No existing process found"
          fi

          # Wait a moment
          sleep 2

          # Clean up old build files (optional)
          log "ğŸ§¹ Cleaning up old logs..."
          find . -name "*.log" -mtime +7 -delete 2>/dev/null || true

          # Start the application
          log "â–¶ï¸ Starting application..."
          nohup node node_modules/.bin/remix-serve ./build/server/index.js > app.log 2>&1 &
          APP_PID=$!
          log "Application started with PID: $APP_PID"

          # Wait for app to start with better error handling
          log "â³ Waiting for application to start..."
          MAX_WAIT=60  # 60 seconds
          for i in $(seq 1 $MAX_WAIT); do
            if curl -s -f http://localhost:3000/health > /dev/null 2>&1; then
              log "âœ… Application deployed successfully!"
              log "ğŸ“Š Application status:"
              curl -s http://localhost:3000/health || true

              # Verify database connectivity
              log "ğŸ” Verifying database connectivity..."
              if curl -s http://localhost:3000/health | grep -q "database.*ok"; then
                log "âœ… Database connection verified"
              else
                log "âš ï¸ Database status unclear, but app is responding"
              fi

              log "ğŸ‰ Deployment completed successfully at $(date)"
              exit 0
            fi
            echo "Waiting... ($i/$MAX_WAIT)"
            sleep 1
          done

          log "âŒ Application failed to start within $MAX_WAIT seconds"
          error_exit "application startup"